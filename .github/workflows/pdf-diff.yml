name: Track PDF model changes

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  pull-requests: write

env:
  TZ: "Europe/Amsterdam"

jobs:
  diff:
    name: Diff PDFs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    env:
      CARGO_TERM_COLOR: always
      SQLX_OFFLINE: "true"
      HEAD_REF: ${{ github.head_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: main
      - name: Setup Rust
        run: >
          rustup update stable &&
          rustup default stable
      - name: Cargo cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2
        with:
          workspaces: "backend -> target"
      - name: Generate PDFs
        run: cargo run --bin gen-pdf --features embed-typst -- --directory main
      - name: Switch to current branch
        uses: actions/checkout@v5
        with:
          clean: false
      - name: Generate PDFs on the current branch
        run: cargo run --bin gen-pdf --features embed-typst -- --directory "$HEAD_REF"
      - name: Install diff-pdf
        run: sudo apt-get update && sudo apt-get install -y diff-pdf-wx
      - name: Generate PDF diff summary
        id: diff_summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('node:fs');
            const path = require('node:path');
            const {spawnSync} = require('node:child_process');

            const headRef = process.env.HEAD_REF;
            if (!headRef) {
              core.setFailed('HEAD_REF is not set');
              return;
            }

            const pdfRoot = path.join('backend', 'tmp-pdf-gen');
            const dirs = {
              base: path.join(pdfRoot, 'main'),
              head: path.join(pdfRoot, headRef),
              diff: path.join(pdfRoot, 'diffs'),
            };

            fs.mkdirSync(dirs.diff, {recursive: true});
            fs.closeSync(fs.openSync(path.join(dirs.diff, '.keep'), 'a'));

            const listPdfFiles = (root) => {
              if (!fs.existsSync(root)) {
                return [];
              }

              return fs
                .readdirSync(root, {withFileTypes: true})
                .filter((entry) => entry.isFile() && entry.name.toLowerCase().endsWith('.pdf'))
                .map((entry) => entry.name);
            };

            const allFiles = Array.from(
              new Set([...listPdfFiles(dirs.base), ...listPdfFiles(dirs.head)])
            ).sort();

            const rows = [
              '### PDF Diff Summary',
              '',
              '| File | Status |',
              '| --- | --- |'
            ];

            const statusLabels = {
              identical: '‚úÖ No changes',
              diff: '‚ö†Ô∏è Changes',
              added: 'üÜï Added',
              removed: 'üóëÔ∏è Removed',
            };

            let diffFound = false;

            for (const relativePath of allFiles) {
              const baseFile = path.join(dirs.base, relativePath);
              const headFile = path.join(dirs.head, relativePath);
              const hasBase = fs.existsSync(baseFile);
              const hasHead = fs.existsSync(headFile);
              let status = '';

              if (hasBase && hasHead) {
                const diffOutput = path.join(dirs.diff, relativePath);
                const {status: exitCode} = spawnSync('diff-pdf', [
                  '--mark-differences',
                  '--skip-identical',
                  `--output-diff=${diffOutput}`,
                  baseFile,
                  headFile,
                ], {stdio: 'inherit'});

                if (exitCode === 0) {
                  status = statusLabels.identical;
                  fs.rmSync(diffOutput, {force: true});
                  core.info(`No differences in ${relativePath}`);
                } else if (exitCode === 1) {
                  status = statusLabels.diff;
                  diffFound = true;
                  core.info(`Differences found in ${relativePath}`);
                } else {
                  throw new Error(`diff-pdf failed for ${relativePath} with exit code ${exitCode}`);
                }
              } else if (hasHead) {
                status = statusLabels.added;
                diffFound = true;
                core.info(`File ${relativePath} added on ${headRef}`);
              } else {
                status = statusLabels.removed;
                diffFound = true;
                core.info(`File ${relativePath} removed on ${headRef}`);
              }

              rows.push(`| ${relativePath} | ${status} |`);
            }

            rows.push('');

            core.setOutput('table', rows.join('\n'));
            core.setOutput('diff_found', diffFound ? '1' : '0');
      - name: Upload diff artifacts
        id: artifact-upload
        if: ${{ steps.diff_summary.outputs.diff_found == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: pdf-diffs
          path: backend/tmp-pdf-gen/diffs/
      - name: Comment on PR with PDF diff summary
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- pdf-diff-comment -->';
            const table = ${{ toJson(steps.diff_summary.outputs.table) }};
            const artifactId = ${{ toJson(steps.artifact-upload.outputs['artifact-id'] || '') }};

            if (!table) {
              core.setFailed('PDF diff table is empty');
              return;
            }

            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;

            const artifactLine = artifactId
              ? `[Download ZIP file containing PDF files with the visual differences](https://github.com/${owner}/${repo}/actions/runs/${context.runId}/artifacts/${artifactId})`
              : '';

            const body = [marker, table, artifactLine].filter(Boolean).join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
