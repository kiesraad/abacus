name: PDFs model changes

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  pull-requests: write

env:
  TZ: "Europe/Amsterdam"

jobs:
  diff:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    env:
      CARGO_TERM_COLOR: always
      SQLX_OFFLINE: "true"
      HEAD_REF: ${{ github.head_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: main
      - name: Setup Rust
        run: >
          rustup update stable &&
          rustup default stable
      - name: Cargo cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2
        with:
          workspaces: "backend -> target"
      - name: Generate PDFs
        run: cargo run --bin gen-pdf --features embed-typst -- --directory main
      - name: Switch to current branch
        uses: actions/checkout@v5
        with:
          clean: false
      - name: Generate PDFs on the current branch
        run: cargo run --bin gen-pdf --features embed-typst -- --directory "$HEAD_REF"
      - name: Install diff-pdf
        run: sudo apt-get update && sudo apt-get install -y diff-pdf-wx
      - name: Diff PDFs
        id: diff_pdfs
        shell: bash
        run: |
          set -euo pipefail
          BASE_DIR="tmp-pdf-gen/main"
          HEAD_DIR="tmp-pdf-gen/${HEAD_REF}"
          DIFF_DIR="tmp-pdf-gen/diffs"
          mkdir -p "$DIFF_DIR"
          touch "$DIFF_DIR/.keep"

          base_list=$(mktemp)
          head_list=$(mktemp)
          all_list=$(mktemp)
          table_file=$(mktemp)

          if [ -d "$BASE_DIR" ]; then
            (cd "$BASE_DIR" && find . -type f -name "*.pdf" -printf '%P\n') | sort > "$base_list"
          else
            : > "$base_list"
          fi

          if [ -d "$HEAD_DIR" ]; then
            (cd "$HEAD_DIR" && find . -type f -name "*.pdf" -printf '%P\n') | sort > "$head_list"
          else
            : > "$head_list"
          fi

          # Combine and deduplicate file lists
          cat "$base_list" "$head_list" | sort -u > "$all_list"

          echo "| File | Status |" > "$table_file"
          echo "| --- | --- |" >> "$table_file"

          DIFF_FOUND=0

          while IFS= read -r file_name || [ -n "$file_name" ]; do
            if [ -z "$file_name" ]; then
              continue
            fi

            base_file="$BASE_DIR/$file_name"
            head_file="$HEAD_DIR/$file_name"
            status=""

            if [ -f "$base_file" ] && [ -f "$head_file" ]; then
              diff_output="$DIFF_DIR/$file_name"
              mkdir -p "$(dirname "$diff_output")"
              if diff-pdf --mark-differences --skip-identical --output-diff="$diff_output" "$head_file" "$base_file"; then
                status="âœ… Unchanged"
                rm -f "$diff_output"
                echo "No differences in $file_name"
              else
                exit_code=$?
                if [ $exit_code -eq 1 ]; then
                  status="âš ï¸ Changed"
                  DIFF_FOUND=1
                  echo "Differences found in $file_name"
                else
                  echo "diff-pdf failed for $file_name with exit code $exit_code" >&2
                  exit $exit_code
                fi
              fi
            elif [ -f "$head_file" ]; then
              status="ðŸ†• Added"
              DIFF_FOUND=1
              echo "File $file_name added on ${HEAD_BRANCH}"
            else
              status="ðŸ—‘ï¸ Removed"
              DIFF_FOUND=1
              echo "File $file_name removed on ${HEAD_BRANCH}"
            fi

            printf '| %s | %s |\n' "$file_name" "$status" >> "$table_file"
          done < "$all_list"

          table_contents=$(cat "$table_file")
          {
            echo "table<<EOF"
            printf '%s\n' "$table_contents"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "diff_found=$DIFF_FOUND" >> "$GITHUB_OUTPUT"
      - name: Upload diff artifacts
        if: ${{ steps.diff_pdfs.outputs.diff_found == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: pdf-diffs
          path: backend/tmp-pdf-gen/diffs/
      - name: Comment on PR with PDF diff summary
        if: ${{ github.event_name == 'pull_request' && steps.diff_pdfs.outputs.diff_found == '1' }}
        uses: actions/github-script@v7
        env:
          PDF_DIFF_TABLE: ${{ steps.diff_pdfs.outputs.table }}
        with:
          script: |
            const marker = '<!-- pdf-diff-comment -->';
            const table = process.env.PDF_DIFF_TABLE;

            if (!table) {
              core.setFailed('PDF diff table is empty');
              return;
            }

            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;

            let artifactLine = '';

            try {
              const {data} = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: context.runId,
                per_page: 100,
              });
              const artifact = data.artifacts.find(entry => entry.name === 'pdf-diffs');
              if (artifact) {
                const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}/artifacts/${artifact.id}`;
                artifactLine = `[Download ZIP file containing PDF files with the visual differences](${artifactUrl})`;
              }
            } catch (error) {
              core.warning(`Unable to fetch artifacts: ${error.message}`);
            }

            const body = [
              marker,
              '### PDF diff summary',
              '',
              table,
              '',
              artifactLine,
            ].join('\n').trim();

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
