name: Track PDF model changes

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  pull-requests: write

env:
  TZ: "Europe/Amsterdam"

jobs:
  diff:
    name: Diff PDFs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    env:
      CARGO_TERM_COLOR: always
      SQLX_OFFLINE: "true"
      HEAD_REF: ${{ github.head_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: main
      - name: Setup Rust
        run: >
          rustup update stable &&
          rustup default stable
      - name: Cargo cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2
        with:
          workspaces: "backend -> target"
      - name: Generate PDFs
        run: cargo run --bin gen-pdf --features embed-typst -- --directory main
      - name: Switch to current branch
        uses: actions/checkout@v5
        with:
          clean: false
      - name: Generate PDFs on the current branch
        run: cargo run --bin gen-pdf --features embed-typst -- --directory "$HEAD_REF"
      - name: Install diff-pdf
        run: sudo apt-get update && sudo apt-get install -y diff-pdf-wx
      - name: Generate PDF diff summary
        id: diff_summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('node:fs');
            const path = require('node:path');
            const {spawnSync} = require('node:child_process');

            const headRef = process.env.HEAD_REF;
            if (!headRef) {
              core.setFailed('HEAD_REF is not set');
              return;
            }

            const baseDir = path.join('backend', 'tmp-pdf-gen', 'main');
            const headDir = path.join('backend', 'tmp-pdf-gen', headRef);
            const diffDir = path.join('backend', 'tmp-pdf-gen', 'diffs');

            fs.mkdirSync(diffDir, {recursive: true});
            fs.closeSync(fs.openSync(path.join(diffDir, '.keep'), 'a'));

            const listPdfFiles = (root) => {
              if (!fs.existsSync(root)) {
                return [];
              }

              return fs
                .readdirSync(root, {withFileTypes: true})
                .filter((entry) => entry.isFile() && entry.name.toLowerCase().endsWith('.pdf'))
                .map((entry) => entry.name)
                .sort();
            };

            const baseFiles = listPdfFiles(baseDir);
            const headFiles = listPdfFiles(headDir);
            const allFiles = Array.from(new Set([...baseFiles, ...headFiles])).sort();

            const rows = [
              '### PDF Diff Summary',
              '',
              '| File | Status |',
              '| --- | --- |'
            ];

            let diffFound = false;

            for (const relativePath of allFiles) {
              const baseFile = path.join(baseDir, relativePath);
              const headFile = path.join(headDir, relativePath);
              let status = '';

              if (fs.existsSync(baseFile) && fs.existsSync(headFile)) {
                const diffOutput = path.join(diffDir, relativePath);
                const result = spawnSync('diff-pdf', [
                  '--mark-differences',
                  '--skip-identical',
                  `--output-diff=${diffOutput}`,
                  baseFile,
                  headFile,
                ], {stdio: 'inherit'});

                if (result.status === 0) {
                  status = '‚úÖ No changes';
                  fs.rmSync(diffOutput, {force: true});
                  core.info(`No differences in ${relativePath}`);
                } else if (result.status === 1) {
                  status = '‚ö†Ô∏è Changes';
                  diffFound = true;
                  core.info(`Differences found in ${relativePath}`);
                } else {
                  throw new Error(`diff-pdf failed for ${relativePath} with exit code ${result.status}`);
                }
              } else if (fs.existsSync(headFile)) {
                status = 'üÜï Added';
                diffFound = true;
                core.info(`File ${relativePath} added on ${headRef}`);
              } else {
                status = 'üóëÔ∏è Removed';
                diffFound = true;
                core.info(`File ${relativePath} removed on ${headRef}`);
              }

              rows.push(`| ${relativePath} | ${status} |`);
            }

            rows.push('\n');

            core.setOutput('table', rows.join('\n'));
            core.setOutput('diff_found', diffFound ? '1' : '0');
      - name: Upload diff artifacts
        if: ${{ steps.diff_summary.outputs.diff_found == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: pdf-diffs
          path: backend/tmp-pdf-gen/diffs/
      - name: Comment on PR with PDF diff summary
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- pdf-diff-comment -->';
            const table = ${{ toJson(steps.diff_summary.outputs.table) }};

            if (!table) {
              core.setFailed('PDF diff table is empty');
              return;
            }

            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;

            let artifactLine = '';

            try {
              const {data} = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: context.runId,
                per_page: 100,
              });
              const artifact = data.artifacts.find(entry => entry.name === 'pdf-diffs');
              if (artifact) {
                const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}/artifacts/${artifact.id}`;
                artifactLine = `[Download ZIP file containing PDF files with the visual differences](${artifactUrl})`;
              }
            } catch (error) {
              core.warning(`Unable to fetch artifacts: ${error.message}`);
            }

            const body = `${marker}\n${table}\n${artifactLine}`.trim();

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
